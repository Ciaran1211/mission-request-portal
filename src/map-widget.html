<!DOCTYPE html>
<!--
================================================================================
MAP DRAWING WIDGET - Mission Area Definition Tool
================================================================================
Version: 2.0.0 (Optimized)
Last Updated: 2025-01-10

PURPOSE:
--------
Interactive map widget for drawing mission boundaries. Embedded as an iframe
in the main form (index.html). Provides:
- Drawing tools: Polygon, Rectangle, Circle, Line, Point
- Layer switching: Street map, Satellite, Site orthophoto
- KML export for mission area data
- Fullscreen mode for detailed work

COMMUNICATION:
--------------
Uses postMessage API to communicate with parent form:
- Sends: kmlData, widgetReady, featureCount
- Receives: changeSite, getKml, submit

DEPENDENCIES:
-------------
- OpenLayers 8.2.0 (ol.js) - Map rendering and interactions
- DM Sans font - Typography consistency with main form

SITE CONFIGURATION:
-------------------
Sites are defined in the SITES object with:
- name: Display name
- company: Parent company
- tileUrl: Orthophoto tile server URL
- center: [longitude, latitude]
- defaultZoom: Initial zoom level
================================================================================
-->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Map Drawing Widget</title>
    
    <!-- ====================================================================
         OPENLAYERS MAP LIBRARY
         ====================================================================
         Version 8.2.0 - Full-featured web mapping library
         Provides: Map rendering, vector layers, drawing interactions, KML export
         ==================================================================== -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@8.2.0/ol.css">
    <script src="https://cdn.jsdelivr.net/npm/ol@8.2.0/dist/ol.js"></script>
    
    <!-- ====================================================================
         WIDGET STYLES
         ====================================================================
         Self-contained styles for the map widget.
         Uses same design tokens as main application for consistency.
         ==================================================================== -->
    <style>
        /* ================================================================
           DESIGN TOKENS
           ================================================================
           Matches variables from main styles.css for visual consistency.
           ================================================================ */
        @import url('https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600&display=swap');
        
        :root {
            /* Primary Colors */
            --navy: #0F2458;
            --blue-mid: #5381A1;
            --cyan: #0ABAEF;
            --light-bg: #E8EEF5;
            
            /* Accent Colors */
            --pink: #E92F8B;
            --orange: #E76F41;
            --yellow: #FEE980;
            --white: #ffffff;
            --green: #10B981;
            
            /* Shadows */
            --shadow-sm: 0 1px 3px rgba(15, 36, 88, 0.08);
            --shadow-lg: 0 20px 40px rgba(15, 36, 88, 0.25);
        }
        
        /* ================================================================
           BASE RESET & LAYOUT
           ================================================================ */
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
        }
        
        body {
            font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--light-bg);
            color: var(--navy);
            line-height: 1.5;
            overflow: hidden;
        }
        
        /* Main widget container - vertical flex layout */
        .widget-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
            padding: 16px;
            height: 100vh;
            background: var(--light-bg);
            transition: all 0.3s ease;
        }

        /* ================================================================
           SITE HEADER
           ================================================================
           Displays current site name and company.
           Updated dynamically when site changes.
           ================================================================ */
        .site-header {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            background: var(--navy);
            border-radius: 10px;
            color: var(--white);
            flex-shrink: 0;
        }
        
        .site-icon {
            width: 40px;
            height: 40px;
            background: var(--blue-mid);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* ================================================================
           TOOLBAR
           ================================================================
           Contains drawing tools, action buttons, and layer switcher.
           Organized into logical groups with visual separators.
           ================================================================ */
        .toolbar {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            padding: 12px;
            background: var(--white);
            border-radius: 10px;
            box-shadow: var(--shadow-sm);
            flex-shrink: 0;
        }
        
        /* Tool groups with divider */
        .toolbar-group {
            display: flex;
            gap: 4px;
            padding-right: 12px;
            border-right: 1px solid var(--light-bg);
        }
        .toolbar-group:last-child { 
            border-right: none; 
            padding-right: 0; 
        }
        
        /* Tool button base styles */
        .tool-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 8px 14px;
            font-size: 13px;
            font-weight: 500;
            color: var(--navy);
            background: var(--light-bg);
            border: 1px solid transparent;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.15s ease;
        }
        
        .tool-btn:hover { background: #d9e4ef; }
        .tool-btn.active { background: var(--cyan); color: var(--white); }
        .tool-btn.danger { color: var(--orange); }
        .tool-btn.danger:hover { background: #fef3ed; }
        .tool-btn.success { color: var(--green); }
        .tool-btn.success:hover { background: #ecfdf5; }
        .tool-btn svg { width: 16px; height: 16px; }
        
        /* ================================================================
           MAP CONTAINER
           ================================================================
           Holds the OpenLayers map and overlay controls.
           Fills remaining vertical space.
           ================================================================ */
        .map-wrapper {
            position: relative;
            flex: 1;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: var(--shadow-sm);
            min-height: 300px;
        }
        
        #map { 
            width: 100%; 
            height: 100%; 
            background: #d9e4ef; 
        }
        
        /* Fullscreen toggle button - top right corner */
        .map-controls {
            position: absolute;
            top: 12px;
            right: 12px;
            z-index: 100;
        }
        
        /* Feature count overlay - bottom right */
        .map-overlay {
            position: absolute;
            bottom: 12px;
            right: 12px;
            padding: 8px 12px;
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(4px);
            border-radius: 6px;
            font-size: 12px;
            color: var(--blue-mid);
            pointer-events: none;
            z-index: 100;
        }
        
        /* ================================================================
           STATUS BAR
           ================================================================
           Shows current tool status and mouse coordinates.
           Layer selector buttons on the right side.
           ================================================================ */
        .status-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 14px;
            background: var(--white);
            border-radius: 8px;
            font-size: 12px;
            box-shadow: var(--shadow-sm);
            flex-shrink: 0;
        }
        
        /* Status indicator dot with animation */
        .status-dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--blue-mid);
            margin-right: 6px;
        }
        .status-dot.ready { background: var(--cyan); }
        .status-dot.drawing { 
            background: var(--yellow); 
            animation: pulse 1.5s infinite; 
        }
        
        @keyframes pulse { 
            0%, 100% { opacity: 1; } 
            50% { opacity: 0.5; } 
        }
        
        /* Layer switcher buttons */
        .layer-selector { 
            display: flex; 
            gap: 4px; 
            margin-left: auto; 
        }
        
        .layer-btn {
            padding: 6px 10px;
            font-size: 11px;
            font-weight: 500;
            background: var(--light-bg);
            border: 1px solid #d9e4ef;
            border-radius: 4px;
            cursor: pointer;
            color: var(--navy);
        }
        .layer-btn.active { 
            background: var(--navy); 
            color: var(--white); 
        }
        
        /* ================================================================
           MODAL DIALOG
           ================================================================
           Used for confirmations (clear all, fullscreen, etc.)
           Animated appearance with backdrop blur.
           ================================================================ */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(15, 36, 88, 0.6);
            backdrop-filter: blur(2px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 20000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s, visibility 0.2s;
        }
        
        .modal-overlay.show { 
            opacity: 1; 
            visibility: visible; 
        }
        
        .modal-box {
            background: var(--white);
            border-radius: 12px;
            padding: 24px;
            width: 90%;
            max-width: 340px;
            box-shadow: var(--shadow-lg);
            transform: scale(0.95);
            transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        
        .modal-overlay.show .modal-box { 
            transform: scale(1); 
        }
        
        .modal-title { 
            font-size: 18px; 
            font-weight: 600; 
            color: var(--navy); 
            margin-bottom: 8px; 
        }
        
        .modal-message { 
            font-size: 14px; 
            color: var(--blue-mid); 
            margin-bottom: 24px; 
            line-height: 1.5; 
        }
        
        .modal-buttons { 
            display: flex; 
            gap: 12px; 
            justify-content: flex-end; 
        }
        
        .modal-btn {
            padding: 10px 20px;
            font-size: 14px;
            font-weight: 500;
            border-radius: 8px;
            cursor: pointer;
            border: none;
            transition: background 0.15s;
        }
        
        .modal-btn.cancel { 
            background: var(--light-bg); 
            color: var(--navy); 
        }
        .modal-btn.cancel:hover { background: #d9e4ef; }
        
        .modal-btn.primary { 
            background: var(--cyan); 
            color: var(--white); 
        }
        .modal-btn.primary:hover { filter: brightness(1.1); }
        
        .modal-btn.danger { 
            background: var(--orange); 
            color: var(--white); 
        }
        .modal-btn.danger:hover { background: #d4623a; }

        /* Fullscreen toggle button */
        .fs-toggle-btn {
            background: var(--white);
            border: none;
            border-radius: 6px;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: var(--navy);
            box-shadow: var(--shadow-sm);
        }
        .fs-toggle-btn:hover { background: var(--light-bg); }
        
        /* Debug panel (hidden by default) */
        .debug-panel { 
            display: none; 
            padding: 10px; 
            background: #fef9e6; 
            color: var(--orange); 
            font-family: monospace; 
            font-size: 11px; 
            margin-bottom: 10px; 
            border-radius: 6px;
        }
        .debug-panel.show { display: block; }
    </style>
</head>
<body>
    <!-- ====================================================================
         WIDGET ROOT CONTAINER
         ==================================================================== -->
    <div class="widget-container" id="widgetRoot">
        
        <!-- ================================================================
             SITE HEADER
             ================================================================
             Shows current site context. Updated when site changes.
             ================================================================ -->
        <div class="site-header">
            <div class="site-icon" aria-hidden="true">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
                    <circle cx="12" cy="10" r="3"/>
                </svg>
            </div>
            <div>
                <h4 id="siteName">Loading...</h4>
                <p id="siteInfo" style="font-size: 12px; opacity: 0.8;">Initializing map</p>
            </div>
        </div>
        
        <!-- Debug panel for development (hidden in production) -->
        <div class="debug-panel" id="debugPanel" role="log" aria-live="polite"></div>
        
        <!-- ================================================================
             DRAWING TOOLBAR
             ================================================================
             Organized into groups:
             - Shape tools: Polygon, Rectangle, Circle
             - Line tools: Line, Point
             - Actions: Undo, Clear
             - Export: Download KML
             - Layers: Street, Satellite, Ortho
             ================================================================ -->
        <div class="toolbar" role="toolbar" aria-label="Drawing tools">
            <!-- Shape Drawing Tools -->
            <div class="toolbar-group" role="group" aria-label="Shape tools">
                <button class="tool-btn" data-tool="Polygon" title="Draw Polygon" aria-pressed="false">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                        <polygon points="12,2 22,8.5 22,15.5 12,22 2,15.5 2,8.5"/>
                    </svg> 
                    Polygon
                </button>
                <button class="tool-btn" data-tool="Box" title="Draw Rectangle" aria-pressed="false">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                        <rect x="3" y="3" width="18" height="18" rx="2"/>
                    </svg> 
                    Rectangle
                </button>
                <button class="tool-btn" data-tool="Circle" title="Draw Circle" aria-pressed="false">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                        <circle cx="12" cy="12" r="10"/>
                    </svg> 
                    Circle
                </button>
            </div>
            
            <!-- Line/Point Tools -->
            <div class="toolbar-group" role="group" aria-label="Line and point tools">
                <button class="tool-btn" data-tool="LineString" title="Draw Line" aria-pressed="false">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                        <path d="M4 20L20 4"/>
                        <circle cx="4" cy="20" r="2" fill="currentColor"/>
                        <circle cx="20" cy="4" r="2" fill="currentColor"/>
                    </svg> 
                    Line
                </button>
                <button class="tool-btn" data-tool="Point" title="Place Point" aria-pressed="false">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                        <circle cx="12" cy="12" r="3" fill="currentColor"/>
                        <circle cx="12" cy="12" r="8"/>
                    </svg> 
                    Point
                </button>
            </div>
            
            <!-- Action Buttons -->
            <div class="toolbar-group" role="group" aria-label="Edit actions">
                <button class="tool-btn" id="undoBtn" title="Undo Last">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                        <path d="M3 7v6h6"/>
                        <path d="M3 13a9 9 0 1 0 3-7.7L3 7"/>
                    </svg> 
                    Undo
                </button>
                <button class="tool-btn danger" id="clearBtn" title="Clear All">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                        <path d="M3 6h18M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/>
                    </svg> 
                    Clear
                </button>
            </div>

            <!-- Export Button -->
            <div class="toolbar-group" role="group" aria-label="Export">
                <button class="tool-btn success" id="downloadBtn" title="Download KML">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                        <polyline points="7 10 12 15 17 10"/>
                        <line x1="12" y1="15" x2="12" y2="3"/>
                    </svg> 
                    KML
                </button>
            </div>
            
            <!-- Layer Selector -->
            <div class="layer-selector" role="group" aria-label="Map layers">
                <button class="layer-btn" data-layer="osm" aria-pressed="false">Street</button>
                <button class="layer-btn" data-layer="satellite" aria-pressed="false">Sat</button>
                <button class="layer-btn active" data-layer="ortho" id="orthoBtn" aria-pressed="true">Ortho</button>
            </div>
        </div>
        
        <!-- ================================================================
             MAP CONTAINER
             ================================================================ -->
        <div class="map-wrapper">
            <div id="map" role="application" aria-label="Interactive map for drawing mission areas"></div>
            
            <!-- Fullscreen Toggle -->
            <div class="map-controls">
                <button class="fs-toggle-btn" id="fullscreenToggle" title="Toggle Fullscreen" aria-label="Toggle fullscreen mode">
                    <svg id="icon-maximize" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20" aria-hidden="true">
                        <path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"/>
                    </svg>
                    <svg id="icon-minimize" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20" style="display:none" aria-hidden="true">
                        <path d="M8 3v3a2 2 0 0 1-2 2H3m18 0h-3a2 2 0 0 1-2-2V3m0 18v-3a2 2 0 0 1 2-2h3M3 16h3a2 2 0 0 1 2 2v3"/>
                    </svg>
                </button>
            </div>
            
            <!-- Feature Count Overlay -->
            <div class="map-overlay" aria-live="polite">
                Features: <span style="font-weight:600; color:var(--cyan)" id="featureCount">0</span>
            </div>
        </div>
        
        <!-- ================================================================
             STATUS BAR
             ================================================================ -->
        <div class="status-bar">
            <div style="display: flex; align-items: center;">
                <span class="status-dot ready" id="statusDot" aria-hidden="true"></span>
                <span id="statusText">Ready</span>
            </div>
            <span id="coordDisplay" style="font-family: monospace;" aria-label="Mouse coordinates">--</span>
        </div>
        
        <!-- ================================================================
             CONFIRMATION MODAL
             ================================================================ -->
        <div class="modal-overlay" id="genericModal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
            <div class="modal-box">
                <div class="modal-title" id="modalTitle">Title</div>
                <div class="modal-message" id="modalMessage">Message</div>
                <div class="modal-buttons">
                    <button class="modal-btn cancel" id="modalCancel">Cancel</button>
                    <button class="modal-btn primary" id="modalConfirm">Confirm</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ====================================================================
         MAP WIDGET JAVASCRIPT
         ====================================================================
         Self-contained script that:
         1. Initializes OpenLayers map with multiple base layers
         2. Provides drawing tools with undo/clear functionality
         3. Generates KML from drawn features
         4. Communicates with parent frame via postMessage
         5. Handles site switching and fullscreen mode
         ==================================================================== -->
    <script>
        (function() {
            'use strict';
            
            // ================================================================
            // SITE CONFIGURATION
            // ================================================================
            // Each site has orthophoto tiles, center coordinates, and zoom level.
            // Can be extended by parent application via postMessage.
            // ================================================================
            const SITES = {
                // BMA Sites
                'SR': {
                    name: 'Saraji',
                    company: 'BMA',
                    tileUrl: 'https://s3-map-tiles.s3.ap-southeast-2.amazonaws.com/sites/saraji/{z}/{x}/{y}.png',
                    center: [148.30, -22.42],
                    defaultZoom: 15
                },
                'GR': {
                    name: 'Goonyella',
                    company: 'BMA',
                    tileUrl: 'https://s3-map-tiles.s3.ap-southeast-2.amazonaws.com/sites/goonyella/{z}/{x}/{y}.png',
                    center: [147.97, -21.74],
                    defaultZoom: 15
                },
                'PK': {
                    name: 'Peak Downs',
                    company: 'BMA',
                    tileUrl: 'https://s3-map-tiles.s3.ap-southeast-2.amazonaws.com/sites/peak-downs/{z}/{x}/{y}.png',
                    center: [148.19, -22.26],
                    defaultZoom: 15
                },
                
                // Goldfields Sites
                'GY': {
                    name: 'Gruyere',
                    company: 'Goldfields',
                    tileUrl: 'https://s3-map-tiles.s3.ap-southeast-2.amazonaws.com/sites/gruyere/{z}/{x}/{y}.png',
                    center: [123.8552, -27.9897],
                    defaultZoom: 15
                },
                
                // Norton Sites
                'BN': {
                    name: 'Binduli North',
                    company: 'Norton',
                    tileUrl: 'https://s3-map-tiles.s3.ap-southeast-2.amazonaws.com/sites/binduli-north/{z}/{x}/{y}.png',
                    center: [121.3825, -30.775],
                    defaultZoom: 15
                },
                
                // Default fallback for overview
                'default': {
                    name: 'Select a Site',
                    company: '',
                    tileUrl: 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
                    center: [134.0, -25.5],
                    defaultZoom: 5
                }
            };
            
            // ================================================================
            // APPLICATION STATE
            // ================================================================
            // Centralized state object for all mutable values.
            // ================================================================
            const State = {
                map: null,              // OpenLayers map instance
                drawSource: null,       // Vector source for drawn features
                drawInteraction: null,  // Current drawing interaction
                featureHistory: [],     // Stack for undo functionality
                site: null,             // Current site configuration
                orthoLayer: null        // Orthophoto tile layer
            };

            // Check if widget is embedded in parent frame
            const inIframe = window.self !== window.top;

            // ================================================================
            // UTILITY FUNCTIONS
            // ================================================================
            
            /**
             * Get URL parameter value
             * @param {string} name - Parameter name
             * @returns {string|null} Parameter value or null
             */
            function getUrlParam(name) { 
                return new URLSearchParams(window.location.search).get(name); 
            }
            
            /**
             * Log debug message (only visible when debug panel is enabled)
             * @param {string} msg - Message to log
             */
            function debug(msg) { 
                const el = document.getElementById('debugPanel');
                if (el) { 
                    el.classList.add('show'); 
                    el.innerHTML += msg + '<br>'; 
                }
                console.log('[MapWidget]', msg);
            }

            /**
             * Send message to parent frame via postMessage API
             * @param {string} type - Message type identifier
             * @param {Object} data - Additional data to send
             */
            function sendToParent(type, data) {
                if (inIframe) {
                    window.parent.postMessage(JSON.stringify({
                        type,
                        ...data,
                        timestamp: new Date().toISOString()
                    }), '*');
                }
            }

            // ================================================================
            // MODAL DIALOG SYSTEM
            // ================================================================
            const Modal = {
                el: document.getElementById('genericModal'),
                titleEl: document.getElementById('modalTitle'),
                msgEl: document.getElementById('modalMessage'),
                confirmBtn: document.getElementById('modalConfirm'),
                cancelBtn: document.getElementById('modalCancel'),

                /**
                 * Show modal with custom content and actions
                 * @param {string} title - Modal title
                 * @param {string} message - Modal message
                 * @param {string} confirmText - Confirm button text
                 * @param {string} type - 'primary' or 'danger'
                 * @param {Function} onConfirm - Callback on confirm
                 */
                show(title, message, confirmText, type, onConfirm) {
                    this.titleEl.textContent = title;
                    this.msgEl.textContent = message;
                    this.confirmBtn.textContent = confirmText || 'Confirm';
                    this.confirmBtn.className = `modal-btn ${type === 'danger' ? 'danger' : 'primary'}`;
                    
                    // Clone button to remove previous event listeners
                    const newConfirm = this.confirmBtn.cloneNode(true);
                    this.confirmBtn.parentNode.replaceChild(newConfirm, this.confirmBtn);
                    this.confirmBtn = newConfirm;

                    this.confirmBtn.addEventListener('click', () => {
                        this.hide();
                        if (onConfirm) onConfirm();
                    });

                    this.el.classList.add('show');
                },
                
                /**
                 * Hide the modal
                 */
                hide() {
                    this.el.classList.remove('show');
                }
            };

            // ================================================================
            // MAP INITIALIZATION
            // ================================================================
            
            /**
             * Initialize the OpenLayers map with all layers and interactions
             */
            function initMap() {
                // Get site from URL or use default
                const siteKey = getUrlParam('site') || 'default';
                State.site = SITES[siteKey] || SITES['default'];

                // Update header display
                document.getElementById('siteName').textContent = State.site.name;
                document.getElementById('siteInfo').textContent = State.site.company || 'Select a site to begin';

                // Create base layers (initially hidden)
                const osm = new ol.layer.Tile({ 
                    source: new ol.source.OSM(), 
                    visible: false, 
                    properties: {name: 'osm'} 
                });
                
                const satellite = new ol.layer.Tile({ 
                    source: new ol.source.XYZ({ 
                        url: 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', 
                        maxZoom: 19 
                    }), 
                    visible: false,
                    properties: {name: 'satellite'} 
                });
                
                // Site-specific orthophoto layer (visible by default)
                State.orthoLayer = new ol.layer.Tile({
                    source: new ol.source.XYZ({ 
                        url: State.site.tileUrl, 
                        minZoom: 0, 
                        maxZoom: 21 
                    }),
                    visible: true,
                    properties: {name: 'ortho'}
                });

                // Vector layer for drawn features
                State.drawSource = new ol.source.Vector();
                const drawLayer = new ol.layer.Vector({
                    source: State.drawSource,
                    style: new ol.style.Style({
                        fill: new ol.style.Fill({ color: 'rgba(10, 186, 239, 0.2)' }),
                        stroke: new ol.style.Stroke({ color: '#0ABAEF', width: 2 }),
                        image: new ol.style.Circle({ 
                            radius: 6, 
                            fill: new ol.style.Fill({ color: '#0ABAEF' }), 
                            stroke: new ol.style.Stroke({ color: '#fff', width: 2 }) 
                        })
                    })
                });

                // Initialize map
                State.map = new ol.Map({
                    target: 'map',
                    layers: [osm, satellite, State.orthoLayer, drawLayer],
                    view: new ol.View({
                        center: ol.proj.fromLonLat(State.site.center),
                        zoom: State.site.defaultZoom,
                        maxZoom: 21
                    }),
                    controls: ol.control.defaults.defaults({ zoom: false }).extend([
                        new ol.control.ScaleLine()
                    ])
                });

                // Update coordinate display on pointer move
                State.map.on('pointermove', evt => {
                    const coords = ol.proj.toLonLat(evt.coordinate);
                    document.getElementById('coordDisplay').textContent = 
                        `${coords[1].toFixed(5)}, ${coords[0].toFixed(5)}`;
                });

                // Update feature count on source change
                State.drawSource.on('change', () => {
                    document.getElementById('featureCount').textContent = 
                        State.drawSource.getFeatures().length;
                    // Send updated KML to parent
                    sendKmlToParent();
                });

                // Send initial KML state after map loads
                setTimeout(sendKmlToParent, 500);
            }

            // ================================================================
            // SITE MANAGEMENT
            // ================================================================
            
            /**
             * Change to a different site
             * @param {string} siteKey - Site identifier key
             */
            function changeSite(siteKey) {
                const newSite = SITES[siteKey];
                if (!newSite) {
                    debug('Site not found: ' + siteKey);
                    return;
                }

                State.site = newSite;
                document.getElementById('siteName').textContent = State.site.name;
                document.getElementById('siteInfo').textContent = State.site.company;

                // Update orthophoto tile source
                State.orthoLayer.setSource(new ol.source.XYZ({ 
                    url: State.site.tileUrl, 
                    minZoom: 0, 
                    maxZoom: 21 
                }));

                // Clear existing drawings
                State.drawSource.clear();
                State.featureHistory = [];

                // Animate to new location
                State.map.getView().animate({
                    center: ol.proj.fromLonLat(State.site.center),
                    zoom: State.site.defaultZoom,
                    duration: 500
                });

                setStatus('ready', 'Site changed');
                sendKmlToParent();
            }

            // ================================================================
            // DRAWING TOOLS
            // ================================================================
            
            /**
             * Set the active drawing tool
             * @param {string|null} toolType - Tool type or null to deactivate
             */
            function setTool(toolType) {
                // Remove existing interaction
                if (State.drawInteraction) {
                    State.map.removeInteraction(State.drawInteraction);
                }
                
                // Update button states
                document.querySelectorAll('.tool-btn[data-tool]').forEach(b => {
                    b.classList.remove('active');
                    b.setAttribute('aria-pressed', 'false');
                });
                
                if (!toolType) { 
                    setStatus('ready', 'Ready'); 
                    return; 
                }
                
                // Activate selected tool button
                const activeBtn = document.querySelector(`[data-tool="${toolType}"]`);
                if (activeBtn) {
                    activeBtn.classList.add('active');
                    activeBtn.setAttribute('aria-pressed', 'true');
                }
                
                // Configure geometry function for special types
                const geometryFunction = toolType === 'Box' ? ol.interaction.Draw.createBox() : undefined;
                const type = (toolType === 'Box' || toolType === 'Circle') ? 'Circle' : toolType;
                
                // Create draw interaction
                State.drawInteraction = new ol.interaction.Draw({ 
                    source: State.drawSource, 
                    type: type, 
                    geometryFunction: geometryFunction 
                });
                
                State.drawInteraction.on('drawstart', () => setStatus('drawing', 'Drawing...'));
                State.drawInteraction.on('drawend', (e) => {
                    State.featureHistory.push(e.feature);
                    setStatus('ready', 'Feature added');
                    sendToJotForm();
                    sendKmlToParent();
                });
                
                State.map.addInteraction(State.drawInteraction);
                setStatus('ready', `${toolType} active`);
            }

            // ================================================================
            // STATUS MANAGEMENT
            // ================================================================
            
            /**
             * Update status indicator and text
             * @param {string} status - Status type ('ready', 'drawing')
             * @param {string} text - Status message
             */
            function setStatus(status, text) {
                const dot = document.getElementById('statusDot');
                dot.className = `status-dot ${status}`;
                document.getElementById('statusText').textContent = text;
            }

            // ================================================================
            // LAYER SWITCHING
            // ================================================================
            
            /**
             * Switch visible map layer
             * @param {string} layerName - Layer to show ('osm', 'satellite', 'ortho')
             */
            function switchLayer(layerName) {
                // Update button states
                document.querySelectorAll('.layer-btn').forEach(b => { 
                    const isActive = b.dataset.layer === layerName;
                    b.classList.toggle('active', isActive);
                    b.setAttribute('aria-pressed', isActive);
                });
                
                // Update layer visibility
                State.map.getLayers().forEach(lyr => { 
                    if (lyr.get('name')) {
                        lyr.setVisible(lyr.get('name') === layerName); 
                    }
                });
            }

            // ================================================================
            // FEATURE MANAGEMENT
            // ================================================================
            
            /**
             * Clear all drawn features with confirmation
             */
            function clearFeatures() {
                if (State.drawSource.getFeatures().length === 0) return;
                
                Modal.show(
                    'Clear All Features?', 
                    'This will remove all shapes you have drawn. This action cannot be undone.', 
                    'Clear All', 
                    'danger', 
                    () => {
                        State.drawSource.clear();
                        State.featureHistory = [];
                        sendToJotForm();
                        sendKmlToParent();
                        setStatus('ready', 'Canvas cleared');
                    }
                );
            }

            // ================================================================
            // FULLSCREEN MODE
            // ================================================================
            
            /**
             * Toggle fullscreen mode with confirmation
             */
            function toggleFullscreen() {
                const doc = document.documentElement;
                
                if (!document.fullscreenElement) {
                    Modal.show(
                        'Enter Fullscreen Mode?', 
                        'This will maximize the map. You can exit by pressing ESC.', 
                        'Go Fullscreen', 
                        'primary', 
                        () => {
                            if (doc.requestFullscreen) doc.requestFullscreen();
                            else if (doc.webkitRequestFullscreen) doc.webkitRequestFullscreen();
                            else if (doc.msRequestFullscreen) doc.msRequestFullscreen();
                        }
                    );
                } else {
                    if (document.exitFullscreen) document.exitFullscreen();
                    else if (document.webkitExitFullscreen) document.webkitExitFullscreen();
                }
            }

            /**
             * Update UI when fullscreen state changes
             */
            function updateFullscreenUI() {
                const isFs = !!document.fullscreenElement;
                document.getElementById('icon-maximize').style.display = isFs ? 'none' : 'block';
                document.getElementById('icon-minimize').style.display = isFs ? 'block' : 'none';
                document.getElementById('fullscreenToggle').title = isFs ? "Exit Fullscreen" : "Toggle Fullscreen";
                
                // Update map size after transition
                setTimeout(() => State.map && State.map.updateSize(), 200);
            }

            // ================================================================
            // KML GENERATION
            // ================================================================
            
            // JotForm integration parameters
            const qid = getUrlParam('qid');
            const inJotForm = (window.self !== window.top) && qid;

            /**
             * Generate KML string from drawn features
             * @returns {string} KML formatted string
             */
            function generateKMLString() {
                const features = State.drawSource.getFeatures();
                if (!features.length) return '';
                
                const format = new ol.format.KML({ 
                    extractStyles: false, 
                    writeStyles: true 
                });
                
                // Clone features and transform to geographic coordinates
                const featuresClone = features.map(f => {
                    const clone = f.clone();
                    let geom = clone.getGeometry();
                    
                    // Convert Circle to Polygon (KML doesn't support circles)
                    if (geom.getType() === 'Circle') {
                        geom = ol.geom.Polygon.fromCircle(geom, 64);
                        clone.setGeometry(geom);
                    }
                    
                    // Transform from Web Mercator to WGS84
                    geom.transform('EPSG:3857', 'EPSG:4326');
                    
                    // Apply consistent styling
                    clone.setStyle(new ol.style.Style({
                        fill: new ol.style.Fill({ color: [239, 186, 10, 0.3] }),
                        stroke: new ol.style.Stroke({ color: [239, 186, 10, 1], width: 2 })
                    }));
                    
                    return clone;
                });
                
                return format.writeFeatures(featuresClone);
            }

            /**
             * Download KML file to user's device
             */
            function downloadKML() {
                const kml = generateKMLString();
                if (!kml) { 
                    setStatus('ready', 'Nothing to download'); 
                    return; 
                }
                
                const blob = new Blob([kml], {type: 'application/vnd.google-earth.kml+xml'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `map-drawing-${Date.now()}.kml`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                setStatus('ready', 'Download started');
            }

            // ================================================================
            // PARENT FRAME COMMUNICATION
            // ================================================================
            
            /**
             * Send KML data to parent frame
             */
            function sendKmlToParent() {
                const kml = generateKMLString();
                if (inIframe) {
                    window.parent.postMessage(JSON.stringify({
                        type: 'kmlData',
                        kml: kml,
                        featureCount: State.drawSource.getFeatures().length,
                        timestamp: new Date().toISOString()
                    }), '*');
                }
            }

            /**
             * Send data to JotForm parent (legacy support)
             */
            function sendToJotForm() {
                if (!inJotForm) return;
                const kml = generateKMLString();
                window.parent.postMessage(JSON.stringify({ 
                    type: 'data', 
                    qid: qid, 
                    value: kml, 
                    valid: true 
                }), '*');
            }

            /**
             * Set up listener for messages from parent frame
             */
            function setupParentCommunication() {
                window.addEventListener('message', function(e) {
                    try {
                        const data = typeof e.data === 'string' ? JSON.parse(e.data) : e.data;
                        
                        // Handle site change request
                        if (data.type === 'changeSite' && data.site) {
                            changeSite(data.site);
                        }
                        
                        // Handle KML request
                        if (data.type === 'getKml') {
                            sendKmlToParent();
                        }

                        // Handle JotForm submit
                        if (data.type === 'submit' && inJotForm) {
                            const kml = generateKMLString();
                            window.parent.postMessage(JSON.stringify({
                                type: 'submit',
                                qid: qid,
                                value: kml,
                                valid: true
                            }), '*');
                        }
                    } catch (err) {
                        // Ignore parse errors from other window messages
                    }
                });
            }

            // ================================================================
            // INITIALIZATION
            // ================================================================
            
            /**
             * Initialize widget and set up all event handlers
             */
            function init() {
                // Initialize OpenLayers map
                initMap();
                
                // Tool button click handlers
                document.querySelectorAll('.tool-btn[data-tool]').forEach(btn => {
                    btn.addEventListener('click', () => {
                        setTool(btn.classList.contains('active') ? null : btn.dataset.tool);
                    });
                });
                
                // Action button handlers
                document.getElementById('undoBtn').addEventListener('click', () => {
                    if (State.featureHistory.length) { 
                        State.drawSource.removeFeature(State.featureHistory.pop()); 
                        sendToJotForm();
                        sendKmlToParent();
                    }
                });
                
                document.getElementById('clearBtn').addEventListener('click', clearFeatures);
                document.getElementById('downloadBtn').addEventListener('click', downloadKML);
                
                // Layer button handlers
                document.querySelectorAll('.layer-btn').forEach(btn => {
                    btn.addEventListener('click', () => switchLayer(btn.dataset.layer));
                });
                
                // Fullscreen handlers
                document.getElementById('fullscreenToggle').addEventListener('click', toggleFullscreen);
                document.addEventListener('fullscreenchange', updateFullscreenUI);
                
                // Modal cancel handler
                document.getElementById('modalCancel').addEventListener('click', () => Modal.hide());
                document.getElementById('genericModal').addEventListener('click', (e) => { 
                    if(e.target.id === 'genericModal') Modal.hide(); 
                });
                
                // Window resize handler (debounced)
                let resizeTimer;
                window.addEventListener('resize', () => {
                    clearTimeout(resizeTimer);
                    resizeTimer = setTimeout(() => State.map && State.map.updateSize(), 100);
                });

                // Set up parent frame communication
                setupParentCommunication();

                // Notify parent that widget is ready
                if (inIframe) {
                    sendToParent('widgetReady', { site: State.site?.name || 'default' });
                    sendKmlToParent();
                }

                // JotForm specific initialization
                if (inJotForm) { 
                    window.parent.postMessage(JSON.stringify({ 
                        type: 'frameReady', 
                        qid: qid 
                    }), '*');
                    sendToJotForm();
                }
            }

            // Start initialization
            init();
        })();
    </script>
</body>
</html>
